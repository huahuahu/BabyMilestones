# Phase 09 安全与隐私技术设计

## 1. 目标
强化用户数据安全：本地存储加密、删除与分享策略明确；隐私政策呈现；避免未授权数据泄漏。

## 2. 范围
- 本地加密策略（文件级或字段级）
- 数据删除擦除保证（头像文件等）
- 隐私页面（解释数据用途、同步策略）
- 导出内容最小化（不含内部元数据）

## 3. 加密策略评估
| 方案 | 优点 | 缺点 |
|------|------|------|
| 文件级（ProtectionComplete） | 简单，系统支持 | 字段级粒度不足 |
| 应用级 AES 加密自定义文件 | 更细粒度控制 | 密钥管理复杂 |

初期采用 iOS Data Protection + 针对头像文件手动设置 `.completeFileProtection`。后续可扩展端到端字段级加密。

## 4. 删除擦除
- 头像文件：`FileManager.removeItem` 后校验不存在
- 记录数据：数据库删除后触发 vacuum（若 SQLite）或 let 系统管理
- 提供“全部数据清除”功能（调用 Stores 清理 + 文件清理）

## 5. 隐私页面内容
- 本地默认不上传
- 开启 iCloud 后使用 CloudKit 私有数据库
- 用户可随时关闭并保留本地副本
- 导出文件仅包含用户录入与标准版本号

## 6. 任务拆分
- [ ] 文件级保护应用于存储目录
- [ ] 头像保存加密选项测试
- [ ] 删除儿童时擦除头像与记录
- [ ] 全局清除数据按钮 + 二次确认
- [ ] 隐私说明视图 + README 中补充

## 7. 测试计划
| 测试 | 内容 |
|------|------|
| testAvatarDeletion | 删除儿童后头像文件不存在 |
| testFullDataWipe | 全局清除后无残留记录 |
| testFileProtectionAttributes | 文件属性包含保护标志 |
| testPrivacyViewStrings | 文案完整显示 |

## 8. 风险与缓解
| 风险 | 影响 | 缓解 |
|------|------|------|
| 自定义加密密钥丢失 | 数据不可用 | 起步不做自定义字段加密 |
| 擦除不彻底 | 残留隐私风险 | 集中管理路径 & 测试覆盖 |
| 用户误清除全部数据 | 损失 | 二次确认 + 建议先导出备份 |

## 9. 可选扩展
- 安全区域检测（越狱判定）限制功能
- 导出加密 Zip（密码用户自设）

## 10. 完成标准
- 删除/擦除流程测试通过
- 隐私页面上线并在设置中访问
- 文件保护属性正确应用
